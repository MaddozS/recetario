---
import { Icon } from "astro-icon/components";
import Layout from "../../layouts/Layout.astro";
import type { Ingredient, Recipe, RecipeIngredientWithData, RecipeIngredient } from '../../content.config';

if (!Astro.locals.session || !Astro.locals.user) {
  return Astro.redirect('/sign-in');
}

import { getEntry } from 'astro:content';

// Obtener el ID de la receta desde los parámetros
const recipeId = Astro.params.recipe;
if (!recipeId) {
  return Astro.redirect('/');
}

// Obtener la receta desde la colección
const recipe = await getEntry('recipes', recipeId);
if (!recipe) {
  return Astro.redirect('/');
}

const { data } = recipe;

const { ingredients, name, id, desiredMargin, fixedCostsPercentage, presentations } = data;

const recipeIngredients: RecipeIngredientWithData[] = [];
for (const ri of ingredients) {
  const ingredientEntry = await getEntry('ingredients', ri.ingredientId.toString());
  recipeIngredients.push({
    ...ri,
    ingredient: ingredientEntry?.data as Ingredient
  });
}

// valores default si no están definidos
const desiredMarginValue = desiredMargin || 0;
const fixedCostsPercentageValue = fixedCostsPercentage || 0;

// --- Helpers de Cálculo ---
  
const getCostoBaseCompra = (insumo: Ingredient) => {
  if (insumo.purchaseQuantity === 0) return 0;
  return insumo.price / insumo.purchaseQuantity;
};

const calcularSubtotalIngrediente = (ri: RecipeIngredient, insumo: Ingredient) => {
  if (!insumo) return 0;
  
  let cantidadAjustada = ri.quantity;
  const unidadInsumo = insumo.unit.toLowerCase();
  const unidadReceta = ri.unit.toLowerCase();

  // Conversión inteligente: si el insumo es kg/lt y la receta usa g/ml
  if ((unidadInsumo === 'kg' || unidadInsumo === 'lt') && 
      (unidadReceta === 'g' || unidadReceta === 'ml')) {
    cantidadAjustada = ri.quantity / 1000;
  }
  
  return getCostoBaseCompra(insumo) * cantidadAjustada;
};

const calcularCostoDirecto = (ingredients: RecipeIngredientWithData[]) => {
  return ingredients.reduce((total, ri) => {
    return total + calcularSubtotalIngrediente(ri, ri.ingredient!);
  }, 0);
};

const costoDirectoTotal = calcularCostoDirecto(recipeIngredients);
const costoOperativo = costoDirectoTotal * ((fixedCostsPercentage || 0) / 100);
const costoProduccionRealBatch = costoDirectoTotal + costoOperativo;
const precioVentaSugeridoBatch = costoProduccionRealBatch / (1 - (desiredMargin / 100))

---

<Layout currentRecipe={id} showSideBar={true} currentPage="recipes">
  <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden" transition:animate="slide">
    <div class="p-8 border-b border-slate-100">
      <div class="flex flex-col md:flex-row justify-between items-start gap-4">
        <div class="flex-1 w-full">
          <input 
            type="text" 
            class="text-3xl font-extrabold bg-transparent border-none focus:ring-0 p-0 w-full mb-2"
            value={name}
          />
          <div class="flex flex-wrap gap-4 text-sm font-medium text-slate-500">
            <span class="flex items-center gap-1.5 bg-slate-100 px-3 py-1 rounded-full">
              <Icon name="lucide:layers"/> Mezcla completa
            </span>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="bg-indigo-50 px-4 py-2 rounded-xl border border-indigo-100">
            <p class="text-[10px] text-indigo-400 font-bold uppercase tracking-wider">Costo Insumos</p>
            <p class="text-xl font-black text-indigo-700">
              ${costoDirectoTotal.toFixed(2)}
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="p-0">
      <table class="w-full text-left">
        <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase font-bold">
          <tr>
            <th class="px-8 py-3">Ingrediente</th>
            <th class="px-8 py-3 text-center">Cantidad</th>
            <th class="px-8 py-3 text-right">Subtotal</th>
            <th class="px-8 py-3 w-12"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          {
          recipeIngredients.map(ri => {
            return (
              <tr class="group">
                <td class="px-8 py-4">
                  {/* <select 
                    class="bg-transparent border-none font-semibold text-slate-700 focus:ring-0 p-0 w-full cursor-pointer"
                    value={ri.ingredienteId}
                  >
                    {insumos.map(i => <option key={i.id} value={i.id}>{i.nombre}</option>)}
                  </select> */}
                  <div class="font-semibold text-slate-700">{ri.ingredient.name}</div>
                </td>
                <td class="px-8 py-4">
                  <div class="flex items-center justify-center gap-2">
                    <input 
                      type="number" 
                      step="0.01"
                      class="w-20 bg-slate-50 border-none rounded-lg p-1.5 text-center font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500/20"
                      value={ri.quantity}
                    />
                    <select 
                      class="text-xs text-slate-400 font-medium lowercase bg-transparent border-none focus:ring-0 p-0 w-10"
                      value={ri.unit}
                    >
                      <option value="g">g</option>
                      <option value="ml">ml</option>
                      <option value="pza">pza</option>
                      <option value="kg">kg</option>
                      <option value="lt">lt</option>
                    </select>
                  </div>
                </td>
                <td class="px-8 py-4 text-right font-mono font-bold text-slate-600">
                  ${calcularSubtotalIngrediente(ri, ri.ingredient!).toFixed(2)}
                </td>
                <td class="px-8 py-4 text-right">
                  <button 
                    class="text-slate-200 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"
                  >
                    <Icon name="lucide:trash-2" />
                  </button>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
      <button 
        class="w-full py-4 bg-slate-50/50 hover:bg-indigo-50 text-indigo-600 text-xs font-bold uppercase tracking-widest flex items-center justify-center gap-2 transition-all border-t border-slate-100"
      >
        <Icon name="lucide:plus" />Añadir Ingrediente
      </button>
    </div>

    <div class="bg-slate-900 text-white p-8 grid grid-cols-1 md:grid-cols-3 gap-8">
      <div class="space-y-4">
        <p class="flex items-center gap-2 text-indigo-400 font-bold text-xs uppercase tracking-widest"><Icon name="lucide:chart-pie" size={14}/> Gastos Operativos</p>
        <div class="flex items-center gap-2 bg-slate-800 p-3 rounded-xl border border-slate-700">
          <input 
            type="number" 
            class="w-12 bg-transparent border-none p-0 text-xl font-black text-white focus:ring-0"
            value={fixedCostsPercentage || 0}
          />
          <span class="text-slate-500 font-bold">% fijos</span>
        </div>
      </div>

      <div class="space-y-4">
        <p class="flex items-center gap-2 text-indigo-400 font-bold text-xs uppercase tracking-widest"><Icon name="lucide:package" size={14}/> Producción Real</p>
        <div class="bg-slate-800 p-3 rounded-xl border border-slate-700 h-12 flex items-center">
          <p class="text-xl font-black">${costoProduccionRealBatch.toFixed(2)} </p>
        </div>
      </div>

      <div class="space-y-4">
        <p class="flex items-center gap-2 text-emerald-400 font-bold text-xs uppercase tracking-widest"><Icon name="lucide:dollar-sign" size={14}/> Margen Utilidad</p>
        <div class="flex items-center gap-2 bg-slate-800 p-3 rounded-xl border border-slate-700">
          <input 
            type="number" 
            class="w-12 bg-transparent border-none p-0 text-xl font-black text-white focus:ring-0"
            value={desiredMarginValue || 0}
          />
          <span class="text-slate-500 font-bold">% deseado</span>
        </div>
      </div>
    </div>
  </div>

  <div>
    <div class="flex items-center justify-between py-4">
      <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
        <Icon name="lucide:tag" class="text-indigo-600" /> Presentaciones de Venta
      </h2>
      <button 
        class="flex items-center gap-2 bg-white text-indigo-600 border border-indigo-200 px-4 py-2 rounded-xl text-sm font-bold hover:bg-indigo-50 transition-all"
      >
        <Icon name="lucide:plus" size={16} /> Nueva Presentación
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {presentations?.map(pres => (
        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:border-indigo-200 transition-all group">
          <div class="flex justify-between items-start mb-4">
            <input 
              type="text" 
              class="font-black text-lg bg-transparent border-none focus:ring-0 p-0 text-slate-800"
              value={pres.name}
            />
            <button 
              class="text-slate-200 hover:text-red-500 transition-colors"
            >
              <Icon name="lucide:trash-2" size={16} />
            </button>
          </div>
          
          <div class="flex items-center gap-3 mb-6 bg-slate-50 p-3 rounded-xl border border-slate-100">
            <span class="text-xs font-bold text-slate-400 uppercase">Unidades x Mezcla:</span>
            <input 
              type="number" 
              class="w-16 bg-white border border-slate-200 rounded-lg text-center font-bold text-indigo-600 focus:ring-2 focus:ring-indigo-500/20"
              value={pres.unitsPerBatch}
            />
          </div>

          <div class="grid grid-cols-2 gap-4 border-t border-slate-50 pt-4">
            <div class="space-y-1">
              <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Costo x Pieza</p>
              <p class="text-xl font-black text-slate-700">${(costoProduccionRealBatch / pres.unitsPerBatch).toFixed(2)}</p>
            </div>
            <div class="space-y-1">
              <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">Venta Sugerida</p>
              <p class="text-xl font-black text-emerald-600">${(precioVentaSugeridoBatch / pres.unitsPerBatch).toFixed(2)}</p>
            </div>
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>
